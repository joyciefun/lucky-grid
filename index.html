<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>九宮格抽獎</title>
<style>
  :root{
    --bg:#f6f7fb;
    --card:#ffffff;
    --border:#d9d9d9;
    --accent:#111111;
    --mask:#ef4444;
    --maskText:#ffffff;
  }

  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif;
    margin:24px;
    background:var(--bg);
  }
  h3{margin:0 0 12px}
  .grid{display:grid;grid-template-columns:repeat(3,110px);gap:10px}
  .cell{
    height:110px; padding:10px;
    display:flex;align-items:center;justify-content:center;
    border:1px solid var(--border);
    border-radius:14px;
    text-align:center;line-height:1.2;
    user-select:none;background:var(--card);
    position:relative; overflow:hidden;
  }
  .active{outline:4px solid var(--accent)}
  button{
    height:110px;width:110px;border-radius:14px;
    border:1px solid var(--accent);
    background:var(--accent);color:#fff;
    font-size:16px;cursor:pointer;
  }
  button:disabled{opacity:.6;cursor:not-allowed}
  .muted{color:#666;font-size:13px;margin-top:12px}

  /* 蓋牌遮罩：revealed 時上滑 */
  .mask{
    position:absolute; inset:0;
    background:var(--mask);
    color:var(--maskText);
    display:flex;align-items:center;justify-content:center;
    font-weight:800; letter-spacing:1px;
    transform:translateY(0);
    transition:transform 260ms ease;
  }
  .revealed .mask{ transform:translateY(-110%); }

  /* 非阻塞彈窗 */
  .overlay{
    position:fixed; inset:0;
    background:rgba(0,0,0,.35);
    display:none; align-items:center; justify-content:center;
    padding:18px;
  }
  .modal{
    width:min(520px, 92vw);
    background:#fff; border-radius:14px;
    border:1px solid #e5e5e5;
    padding:16px 16px 14px;
  }
  .modal h4{margin:0 0 8px; font-size:16px}
  .modal .result{font-size:20px; font-weight:800; margin:10px 0 14px}
  .modal .btnrow{display:flex; justify-content:flex-end}
  .btn2{
    padding:10px 14px; border-radius:10px;
    border:1px solid var(--accent); background:var(--accent); color:#fff;
    cursor:pointer;
  }
</style>
</head>
<body>

<h3>九宮格抽獎</h3>
<div class="grid" id="grid"></div>
<div class="muted">
  抽之前會先看到獎項內容；按「開始」後才會蓋牌並跑燈，停到才翻開。抽完會自動洗牌但不會露出下一輪內容。
</div>

<div class="overlay" id="overlay">
  <div class="modal">
    <h4>抽獎結果</h4>
    <div class="result" id="modalResult">—</div>
    <div class="btnrow">
      <button class="btn2" id="modalOk">確定</button>
    </div>
  </div>
</div>

<script>
  // 延遲參數
  const REVEAL_HOLD_MS = 250;
  const COVER_ANIM_MS  = 260;

  // 順時針 8 格（DOM 位置索引 0..8，不含中間 4）
  const ringPositions = [0,1,2,5,8,7,6,3];

  // 8 格獎項（兩個特別獎分開命名）
  let ringPrizes = [
    "特別獎現金",
    "現金200元",
    "現金600元",
    "刮刮樂200元一張",
    "刮刮樂300元一張",
    "特別獎刮刮樂",
    "大樂透隨機快選4張",
    "刮刮樂500元一張"
  ];

  // 新權重：降低現金200出現比例（更平均）
  let weights = [
    2,  // 特別獎現金
    18, // 現金200
    10, // 現金600
    18, // 刮刮樂200
    16, // 刮刮樂300
    2,  // 特別獎刮刮樂
    10, // 大樂透×4
    6   // 刮刮樂500
  ];

  const grid = document.getElementById("grid");
  const cells = [];
  const ringCells = [];

  for(let i=0;i<9;i++){
    const div = document.createElement("div");

    if(i===4){
      div.innerHTML = `<button id="btn">開始</button>`;
    }else{
      div.className = "cell";
      const ringIdx = ringPositions.indexOf(i);

      const text = document.createElement("div");
      text.className = "text";
      text.textContent = ringPrizes[ringIdx];
      div.appendChild(text);

      const mask = document.createElement("div");
      mask.className = "mask";
      mask.textContent = "紅包";
      div.appendChild(mask);

      ringCells[ringIdx] = div;
    }

    grid.appendChild(div);
    cells.push(div);
  }

  const btn = document.getElementById("btn");
  const overlay = document.getElementById("overlay");
  const modalResult = document.getElementById("modalResult");
  const modalOk = document.getElementById("modalOk");

  function showModal(text){
    modalResult.textContent = text;
    overlay.style.display = "flex";
  }
  function hideModal(){
    overlay.style.display = "none";
  }

  // 音效（不需音檔）
  let audioCtx = null;
  function beep(freq=880, ms=60, type="sine", gain=0.03){
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type; o.frequency.value = freq;
      g.gain.value = gain;
      o.connect(g); g.connect(audioCtx.destination);
      o.start();
      setTimeout(()=>o.stop(), ms);
    }catch(_){}
  }

  function clearActive(){ cells.forEach(c=>c.classList.remove("active")); }
  function highlight(ringIdx){
    clearActive();
    ringCells[ringIdx].classList.add("active");
  }

  function coverAll(){
    for(let i=0;i<8;i++) ringCells[i].classList.remove("revealed");
  }
  function reveal(ringIdx){
    ringCells[ringIdx].classList.add("revealed");
  }

  function redrawTexts(){
    for(let i=0;i<8;i++){
      ringCells[i].querySelector(".text").textContent = ringPrizes[i];
    }
  }

  function shufflePairInPlace(items, ws){
    for(let i=items.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [items[i], items[j]] = [items[j], items[i]];
      [ws[i], ws[j]] = [ws[j], ws[i]];
    }
  }

  function weightedPickIndex(){
    const sum = weights.reduce((a,b)=>a+b,0);
    let r = Math.random() * sum;
    for(let i=0;i<weights.length;i++){
      r -= weights[i];
      if(r < 0) return i;
    }
    return weights.length-1;
  }

  // ✅ 抽前可看獎項：初始不要蓋牌（揭露狀態）
  // revealed = mask 上滑；所以一開始全設 revealed
  for(let i=0;i<8;i++) ringCells[i].classList.add("revealed");

  let running = false;

  btn.onclick = () => {
    if(running) return;
    running = true;
    btn.disabled = true;

    // ✅ 按開始才蓋牌（先讓大家知道有哪些獎）
    coverAll();

    const targetRingIdx = weightedPickIndex();

    let step = 0;
    let delay = 80;
    const totalSteps = 8*4 + targetRingIdx;

    const tick = () => {
      highlight(step % 8);
      beep(880, 20, "sine", 0.02);

      if(step < totalSteps){
        if(step > totalSteps - 12) delay += 25;
        step++;
        setTimeout(tick, delay);
      }else{
        highlight(targetRingIdx);
        reveal(targetRingIdx);
        beep(1320, 90, "triangle", 0.05);

        setTimeout(() => {
          showModal(`抽中：${ringPrizes[targetRingIdx]}`);

          const finalize = () => {
            hideModal();
            overlay.removeEventListener("click", overlayClose);
            modalOk.removeEventListener("click", okClose);

            // 先蓋牌，再洗牌改字（避免露出下一輪）
            coverAll();

            setTimeout(() => {
              shufflePairInPlace(ringPrizes, weights);
              redrawTexts();

              // ✅ 下一輪開始前，再把獎項全部揭露（讓大家看清楚有哪些獎）
              for(let i=0;i<8;i++) ringCells[i].classList.add("revealed");

              running = false;
              btn.disabled = false;
            }, COVER_ANIM_MS);
          };

          const okClose = (e)=>{ e.stopPropagation(); finalize(); };
          const overlayClose = (e)=>{ if(e.target === overlay) finalize(); };

          modalOk.addEventListener("click", okClose, { once:true });
          overlay.addEventListener("click", overlayClose, { once:true });
        }, REVEAL_HOLD_MS);
      }
    };

    tick();
  };
</script>

</body>
</html>
