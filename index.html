<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>九宮格抽獎</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif;margin:24px}
    h3{margin:0 0 12px}
    .grid{display:grid;grid-template-columns:repeat(3,110px);gap:10px}
    .cell{
      height:110px; padding:10px;
      display:flex;align-items:center;justify-content:center;
      border:1px solid #ddd;border-radius:14px;
      text-align:center;line-height:1.2;
      user-select:none;background:#fff;
    }
    .active{outline:3px solid #111}
    button{
      height:110px;width:110px;border-radius:14px;
      border:1px solid #111;background:#111;color:#fff;
      font-size:16px;cursor:pointer;
    }
    button:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:#666;font-size:13px;margin-top:12px}
  </style>
</head>
<body>
  <h3>九宮格抽獎</h3>
  <div class="grid" id="grid"></div>
  <div class="muted">每次點「開始」都會抽出一個獎（可重複）。不同手機各自獨立抽。</div>

  <script>
    // 九宮格8格走位順序（順時針）
    // 格子位置索引（0..8）對應：
    // 0 1 2
    // 3 4 5
    // 6 7 8
    const ringOrder = [0,1,2,5,8,7,6,3];

    // 你要的 7 種獎項（可重複）
    const prizePool = [
      { name: "特別獎",                 weight: 3  },
      { name: "現金200元",              weight: 35 },
      { name: "現金600元",              weight: 8  },
      { name: "刮刮樂200元一張",         weight: 25 },
      { name: "刮刮樂500元一張",         weight: 5  },
      { name: "刮刮樂300元一張",         weight: 16 },
      { name: "大樂透隨機快選4張",       weight: 8  }
    ];

    // 九宮格是 8 格，但獎項 7 種：顯示上讓「特別獎」出現兩格（純顯示用）
    const displayPrizes = [
      "特別獎",
      "現金200元",
      "現金600元",
      "刮刮樂200元一張",
      "刮刮樂500元一張",
      "刮刮樂300元一張",
      "大樂透隨機快選4張",
      "特別獎"
    ];

    const grid = document.getElementById("grid");
    const cells = [];

    // 建格子（8格 + 中間按鈕）
    for(let i=0;i<9;i++){
      const div = document.createElement("div");

      if(i===4){
        div.innerHTML = `<button id="btn">開始</button>`;
      }else{
        const ringIdx = ringOrder.indexOf(i); // 0~7
        div.className = "cell";
        div.textContent = displayPrizes[ringIdx];
      }

      grid.appendChild(div);
      cells.push(div);
    }

    const btn = document.getElementById("btn");
    let running = false;

    function highlightRingIndex(ringIdx){
      cells.forEach(c=>c.classList.remove("active"));
      const pos = ringOrder[ringIdx];      // 轉成格子位置(0..8)
      cells[pos].classList.add("active");
    }

    function weightedPick(pool){
      const sum = pool.reduce((a,b)=>a+b.weight,0);
      let r = Math.random() * sum;
      for(const item of pool){
        r -= item.weight;
        if(r < 0) return item;
      }
      return pool[pool.length - 1];
    }

    btn.onclick = () => {
      if(running) return;
      running = true;
      btn.disabled = true;

      // 1) 抽獎（可重複）
      const picked = weightedPick(prizePool);

      // 2) 決定停在哪個「環」索引（0..7）
      //    若文字重複（特別獎兩格），隨機挑其中一格停
      const candidates = [];
      displayPrizes.forEach((txt, idx) => {
        if(txt === picked.name) candidates.push(idx);
      });

      // 保險：若字串不小心對不上，直接退回停在 0
      const stopRingIndex = candidates.length
        ? candidates[Math.floor(Math.random() * candidates.length)]
        : 0;

      // 3) 動畫：修正步進方式 => 先 step++ 再亮格（避免看起來偏一格）
      let ringStep = -1;        // 先從 -1 開始
      let delay = 80;
      const totalMoves = 8*4 + stopRingIndex; // 移動次數（不是亮格次數）

      const tick = () => {
        ringStep++; // 先移動
        const ringIdx = ringStep % 8;
        highlightRingIndex(ringIdx);

        if(ringStep < totalMoves){
          if(ringStep > totalMoves - 12) delay += 25; // 收尾減速
          setTimeout(tick, delay);
        } else {
          running = false;
          btn.disabled = false;
          alert(`抽中：${picked.name}`);
        }
      };

      tick();
    };
  </script>
</body>
</html>
